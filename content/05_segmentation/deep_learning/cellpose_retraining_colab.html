
<!DOCTYPE html>

<html data-content_root="../../../" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Retraining Cellpose on Custom Data — BoBiAC Book</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css?v=03e43079" rel="stylesheet" type="text/css"/>
<link href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" rel="stylesheet" type="text/css"/>
<link href="../../../_static/togglebutton.css?v=13237357" rel="stylesheet" type="text/css"/>
<link href="../../../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinx-thebe.css?v=4fa983c6" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinx-design.min.css?v=95c83b7e" rel="stylesheet" type="text/css"/>
<link href="../../../_static/styles/custom.css?v=dd2a99f2" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" rel="preload"/>
<script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
<script src="../../../_static/doctools.js?v=9a2dae69"></script>
<script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../../../_static/copybutton.js?v=f281be69"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script src="../../../_static/design-tabs.js?v=f930bc37"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
<script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
<script>DOCUMENTATION_OPTIONS.pagename = 'content/05_segmentation/deep_learning/cellpose_retraining_colab';</script>
<script src="../../../_static/scripts/custom.js?v=4332ec77"></script>
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
<link href="../../06_object_classification/object_classification.html" rel="next" title="06 - Object Classification"/>
<link href="cellpose_notebook.html" rel="prev" title="Cellpose in Python"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</head>
<body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
<div class="skip-link d-print-none" id="pst-skip-link"><a href="#main-content">Skip to main content</a></div>
<div id="pst-scroll-pixel-helper"></div>
<button class="btn rounded-pill" id="pst-back-to-top" type="button">
<i class="fa-solid fa-arrow-up"></i>Back to top</button>
<input class="sidebar-toggle" id="pst-primary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
<input class="sidebar-toggle" id="pst-secondary-sidebar-checkbox" type="checkbox"/>
<label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
</div>
<div class="pst-async-banner-revealer d-none">
<aside aria-label="Version warning" class="d-none d-print-none" id="bd-header-version-warning"></aside>
</div>
<header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
</header>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
</div>
<div class="sidebar-primary-items__start sidebar-primary__section">
<div class="sidebar-primary-item">
<a class="navbar-brand logo" href="../../../landing-page.html">
<img alt="BoBiAC Book - Home" class="logo__image only-light" src="../../../_static/bobiac_logos_svgexport-03.svg"/>
<script>document.write(`<img src="../../../_static/bobiac_logos_svgexport-04.svg" class="logo__image only-dark" alt="BoBiAC Book - Home"/>`);</script>
</a></div>
<div class="sidebar-primary-item">
<script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
<div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<ul class="nav bd-sidenav bd-sidenav__home-link">
<li class="toctree-l1">
<a class="reference internal" href="../../../landing-page.html">
<i class="fas fa-home"></i> Home
                </a>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Material</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../01_intro_to_bobiac/bobiac_intro.html">01 - <i class="fas fa-image"></i> Introduction to BoBiAC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_getting_started_with_python/getting_started_with_python.html">02 - <i class="fab fa-python"></i> Getting Started with Python and <code class="docutils literal notranslate"><span class="pre">uv</span></code></a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../03_python_basics/python_basics.html">03 - <i class="fab fa-python"></i> Python Basics</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../03_python_basics/python_basics_notebook.html">The Python Basics Notebook</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../04_digital_images_intro/digital_images_intro.html">04 - <i class="fas fa-table-cells"></i> Introduction to Digital Images</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../04_digital_images_intro/python_for_bioimage_analysis.html">Python for bioimage analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../segmentation_intro.html">05 - <i class="fa-solid fa-disease"></i> Image Segmentation</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../classic/classic.html">Classical Methods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../classic/classic_segmentation.html">Classical Segmentation</a></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../machine_learning/machine_learning.html">Machine Learning Methods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../machine_learning/intro_to_ilastik.html">Introduction to Ilastik</a></li>
<li class="toctree-l3"><a class="reference internal" href="../machine_learning/pixel_classification_with_ilastik.html">Ilastik for Pixel Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../machine_learning/from_ilastik_masks_to_labels.html">From Ilastik Masks to Labels</a></li>
</ul>
</details></li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="deep_learning.html">Deep Learning Methods</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro_to_cellpose.html">Introduction to Cellpose</a></li>
<li class="toctree-l3"><a class="reference internal" href="cellpose_notebook.html">Cellpose in Python</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Retraining Cellpose on Custom Data</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../06_object_classification/object_classification.html">06 - <i class="fa-solid fa-shapes"></i> Object Classification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../06_object_classification/object_classification_with_ilastik.html">Ilastik for Object Classification</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../07_measurement_and_quantification/measurement_and_quantification_intro.html">07 - <i class="fa-solid fa-chart-simple"></i> Measurements &amp; Quantification</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../07_measurement_and_quantification/measurement_and_quantification_notebook.html">Measurements &amp; Quantification Notebook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../07_measurement_and_quantification/background_correction_notebook.html">Background Correction</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../08_colocalization/colocalization_intro.html">08 - <i class="fa-solid fa-location-crosshairs"></i> Colocalization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../08_colocalization/pixel_intensity_based_colocalization_pearsons.html">Pearson’s correlation coefficient</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../08_colocalization/pixel_intensity_based_colocalization_manders.html">Manders’ Correlation Coefficients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../08_colocalization/object_based_colocalization.html">Object-based colocalization analysis</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_reproducibility_and_image_ethics/reproducibility_and_image_ethics.html">09 - <i class="fa-solid fa-rotate-right"></i> Reproducibility and Image Ethics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Student Working Groups</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../student_group_work/student_group_work.html"><i class="fa-solid fa-user-group"></i> Student Group Work</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../student_group_work/evaluation-notebook.html">Evaluation Notebook</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Materials Downloads</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../data/course_downloads.html"><i class="fa-solid fa-folder"></i> Downloads</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference external" href="https://iac.hms.harvard.edu/bobiac/2025">BoBiAC</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.astral.sh/uv/">uv</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/manzt/juv">juv</a></li>
<li class="toctree-l1"><a class="reference external" href="https://iac.hms.harvard.edu">Image Analysis Collaboratory (IAC)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cite.hms.harvard.edu">Core for Imaging Technology &amp; Education (CITE)</a></li>
</ul>
</div>
</nav></div>
</div>
<div class="sidebar-primary-items__end sidebar-primary__section">
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content" role="main">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
<div class="header-article-items__start">
<div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</button></div>
</div>
<div class="header-article-items__end">
<div class="header-article-item">
<div class="article-header-buttons">
<a class="btn btn-sm btn-source-repository-button" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/HMS-IAC/bobiac" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
</a>
<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>
<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</button>
</div></div>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Retraining Cellpose on Custom Data</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;"> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-you-have-gpu-access">Make sure you have GPU access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mount-your-google-drive">Mount your google drive</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">Download the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-cellpose">Install Cellpose</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-handling">Data Handling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#init-the-model">Init the Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-new-model">Train New Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-on-test-data">Evaluate on test data</a></li>
</ul>
</nav>
</div>
</div>
</div>
<div id="searchbox"></div>
<article class="bd-article">
<section class="tex2jax_ignore mathjax_ignore" id="retraining-cellpose-on-custom-data">
<h1>Retraining Cellpose on Custom Data<a class="headerlink" href="#retraining-cellpose-on-custom-data" title="Link to this heading">#</a></h1>
<div class="custom-button-row">
<a class="custom-button custom-download-button" download="" href="../../../notebooks/05_segmentation/deep_learning/cellpose_retraining_colab.ipynb">
<i class="fas fa-download"></i> Download this Notebook
    </a>
<a class="custom-button custom-download-button" href="https://colab.research.google.com/github/HMS-IAC/bobiac/blob/gh-pages/colab_notebooks/05_segmentation/deep_learning/cellpose_retraining_colab.ipynb" target="_blank">
<img alt="Open in Colab" class="button-icon" src="../../../_static/logo/icon-google-colab.svg"/>
        Open in Colab
    </a>
</div><section id="overview">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>In this section, we’ll walk through how to <strong>retrain Cellpose on your own data</strong>. This is useful when the default models don’t perform well on your specific cell type, staining method, or imaging modality.</p>
<p>Retraining allows Cellpose to learn directly from your examples—leading to better segmentation accuracy and more relevant masks for your experiments.</p>
<p>We’ll cover:</p>
<ul class="simple">
<li><p>Preparing your training data (images + label masks)</p></li>
<li><p>Mounting your Google Drive to access files</p></li>
<li><p>Setting training parameters</p></li>
<li><p>Running the training process</p></li>
<li><p>Evaluating the new model on test images</p></li>
</ul>
<blockquote>
<div><p>💡 You’ll need pairs of raw microscopy images and their corresponding label masks. If you haven’t labeled your images yet, we recommend using the <a class="reference external" href="https://cellpose.readthedocs.io/en/latest/gui.html#training-your-own-cellpose-model">Cellpose GUI</a> to draw or edit masks manually before starting.</p>
</div></blockquote>
<p>The dataset we’ll use here can be downloaded below. It includes both training and test images:
<a download="" href="../../../_static/data/05_segmentation_cellpose_training.zip">
<i class="fas fa-download"></i> Cellpose Training Dataset</a></p>
<p class="alert alert-warning">
<strong>⚠️ Note:</strong> This notebook is designed to run in <a href="https://colab.research.google.com/github/HMS-IAC/bobiac/blob/gh-pages/colab_notebooks/05_segmentation/deep_learning/cellpose_retraining_notebook.ipynb" target="_blank"> Google Colab</a>. If you want to run it locally, you may need to adjust some paths and install the required packages.
</p></section>
<section id="make-sure-you-have-gpu-access">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Make sure you have GPU access<a class="headerlink" href="#make-sure-you-have-gpu-access" title="Link to this heading">#</a></h2>
<p>To Enable GPU:</p>
<ol class="arabic simple">
<li><p>navigate to <code class="docutils literal notranslate"><span class="pre">Runtime</span> <span class="pre">-&gt;</span> <span class="pre">Change</span> <span class="pre">Runtime</span> <span class="pre">Type</span></code></p></li>
<li><p>select <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">3</span></code> as <code class="docutils literal notranslate"><span class="pre">Runtime</span> <span class="pre">Type</span></code></p></li>
<li><p>select one available GPU (e.g. <code class="docutils literal notranslate"><span class="pre">T4</span> <span class="pre">GPU</span></code>) as <code class="docutils literal notranslate"><span class="pre">Hardware</span> <span class="pre">accelerator</span></code>.</p></li>
</ol>
<br/>
<div align="left"> <img alt="Ilastik Logo" src="https://raw.githubusercontent.com/HMS-IAC/bobiac/main/_static/images/cellpose/colab_runtime.png" width="400"/></div>
</section>
<section id="mount-your-google-drive">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Mount your google drive<a class="headerlink" href="#mount-your-google-drive" title="Link to this heading">#</a></h2>
<p>To access the data for the course you first need to mount your Google Drive.</p>
<p>Run the cell below to connect your Google Drive to colab and follow the instructions to authenticate your Google account.</p>
<p>You will need to allow access to your Google Drive so that the notebook can read and write files.</p>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">google.colab</span><span class="w"> </span><span class="kn">import</span> <span class="n">drive</span>

<span class="n">drive</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">"/content/drive"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then click on <code class="docutils literal notranslate"><span class="pre">folder</span> <span class="pre">icon</span></code> on the left bar, press the <code class="docutils literal notranslate"><span class="pre">refresh</span> <span class="pre">button</span></code>. Your Google Drive folder should now be available here (e.g. MyDrive).</p>
<div align="left"> <img alt="Ilastik Logo" src="https://raw.githubusercontent.com/HMS-IAC/bobiac/main/_static/images/cellpose/colab_folder.png" width="300"/></div></section>
<section id="download-the-data">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Download the Data<a class="headerlink" href="#download-the-data" title="Link to this heading">#</a></h2>
<p>Run the cell below to download the data for this exercise and save it in you Google Drive. A new folder called <code class="docutils literal notranslate"><span class="pre">bobiac_data_cellpose</span></code> will be created in your Google Drive.</p>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create directory</span>
<span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>/content/bobiac_data_cellpose
<span class="c1"># Download the data</span>
<span class="o">!</span>wget<span class="w"> </span>https://raw.githubusercontent.com/HMS-IAC/bobiac/main/_static/data/05_segmentation_cellpose_training.zip<span class="w"> </span>-O<span class="w"> </span>/content/bobiac_data_cellpose/05_segmentation_cellpose_training.zip
<span class="c1"># Unzip the data, remove zip file and macOS metadata files (if any)</span>
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>/content/bobiac_data_cellpose<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>unzip<span class="w"> </span>05_segmentation_cellpose_training.zip<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span>05_segmentation_cellpose_training.zip<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>__MACOSX
</pre></div>
</div>
</div>
</div>
</section>
<section id="install-cellpose">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Install Cellpose<a class="headerlink" href="#install-cellpose" title="Link to this heading">#</a></h2>
<div class="cell tag_skip-execution docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !pip install cellpose</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="import-libraries">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Import Libraries<a class="headerlink" href="#import-libraries" title="Link to this heading">#</a></h2>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cellpose</span><span class="w"> </span><span class="kn">import</span> <span class="n">core</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">train</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="setup">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="o">.</span><span class="n">logger_setup</span><span class="p">()</span>  <span class="c1"># to get printing of progress</span>

<span class="n">use_gpu</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"GPU available:"</span><span class="p">,</span> <span class="n">use_gpu</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-handling">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Data Handling<a class="headerlink" href="#data-handling" title="Link to this heading">#</a></h2>
<p>For training, Cellpose expects:</p>
<ul class="simple">
<li><p>A folder of raw images (e.g., TIFF or PNG)</p></li>
<li><p>A matching folder of masks, where each mask corresponds to an image and contains labeled regions</p></li>
</ul>
<p>You’ll also need to <strong>split your data</strong> into a training set and a test set. This allows the model to learn from one portion of the data, and then be evaluated on a separate portion it hasn’t seen before.</p>
<blockquote>
<div><p>✅ The images and masks must have the <strong>same filenames</strong> (e.g., <code class="docutils literal notranslate"><span class="pre">img001.png</span></code> and <code class="docutils literal notranslate"><span class="pre">img001_masks.png</span></code>) so Cellpose can pair them correctly.</p>
</div></blockquote>
<p>During training, Cellpose will:</p>
<ul class="simple">
<li><p>Load batches of training images</p></li>
<li><p>Compare its predictions to the ground-truth masks</p></li>
<li><p>Adjust itself (via backpropagation) to reduce errors over time</p></li>
</ul>
<p>Keep your training and test folders organized and double-check for any mismatches.</p>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ROOT_FOLDER_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"data/05_segmentation_cellpose/retraining"</span><span class="p">)</span>

<span class="n">train_dir</span> <span class="o">=</span> <span class="n">ROOT_FOLDER_PATH</span> <span class="o">/</span> <span class="s2">"train"</span>
<span class="n">test_dir</span> <span class="o">=</span> <span class="n">ROOT_FOLDER_PATH</span> <span class="o">/</span> <span class="s2">"test"</span>

<span class="n">masks_ext</span> <span class="o">=</span> <span class="s2">"_seg.npy"</span>

<span class="c1"># get files</span>
<span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">load_train_test_data</span><span class="p">(</span>
    <span class="n">train_dir</span><span class="p">,</span> <span class="n">test_dir</span><span class="p">,</span> <span class="n">mask_filter</span><span class="o">=</span><span class="n">masks_ext</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert images to float32</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">train_data</span><span class="p">:</span>
    <span class="n">train_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="c1"># same as using list comprehension:</span>
<span class="c1"># train_data = [img.astype(np.float32) for img in train_data]</span>

<span class="c1"># Convert labels (masks) to int32</span>
<span class="n">train_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">train_labels</span><span class="p">:</span>
    <span class="n">train_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="c1"># same as using list comprehension:</span>
<span class="c1"># train_labels = [lbl.astype(np.int32) for lbl in train_labels]</span>

<span class="c1"># Convert test images to float32 and labels to int32</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">test_data</span><span class="p">:</span>
    <span class="n">test_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="c1"># same as using list comprehension:</span>
<span class="c1"># test_data = [img.astype(np.float32) for img in test_data]</span>

<span class="c1"># Convert test labels (masks) to int32</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">test_labels</span><span class="p">:</span>
    <span class="n">test_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<span class="c1"># same as using list comprehension:</span>
<span class="c1"># test_labels = [lbl.astype(np.int32) for lbl in test_labels]</span>
</pre></div>
</div>
</div>
</div>
<section id="init-the-model">
<h3 style="color: black; background-color: rgb(190,223,185); padding: 3px; border-radius: 5px;">Init the Model<a class="headerlink" href="#init-the-model" title="Link to this heading">#</a></h3>
<p>Before we can train a new model, we need to initialize Cellpose with the correct settings.</p>
<p>Here, we’ll:</p>
<ul class="simple">
<li><p>Specify the <strong>model type</strong> (e.g., “cpsam” (default), “cyto” or “nuclei”) to use as a base model</p></li>
<li><p>Set the <strong>channels</strong> depending on how your images are structured (e.g., single-channel grayscale, or dual-channel with nuclei and cytoplasm)</p></li>
<li><p>Choose where to <strong>save the model weights</strong> during training</p></li>
</ul>
<blockquote>
<div><p>💡 Even when training a new model, Cellpose builds on a pre-trained backbone (unless you explicitly start from scratch). This helps it learn faster and perform better—especially on small datasets.</p>
</div></blockquote>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the Cellpose model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CellposeModel</span><span class="p">(</span><span class="n">gpu</span><span class="o">=</span><span class="n">use_gpu</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="s2">"cpsam"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># run model on test images</span>
<span class="n">masks</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># check performance using ground truth labels</span>
<span class="n">ap</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">average_precision</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">masks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; average precision at iou threshold 0.5 = </span><span class="si">{</span><span class="n">ap</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="train-new-model">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Train New Model<a class="headerlink" href="#train-new-model" title="Link to this heading">#</a></h2>
<p>Now we’re ready to train! In this step, we’ll tell Cellpose to:</p>
<ul class="simple">
<li><p>Use the training images and masks</p></li>
<li><p>Save the trained model to your specified directory</p></li>
<li><p>Run for a defined number of <strong>epochs</strong> (iterations over the full dataset)</p></li>
</ul>
<p>You can also set other options like:</p>
<ul class="simple">
<li><p>Learning rate</p></li>
<li><p>Batch size</p></li>
<li><p>Whether to use GPU</p></li>
</ul>
<blockquote>
<div><p>💡 Training time will vary depending on your dataset size and hardware. On Google Colab with a GPU, small datasets may train in just a few minutes.</p>
</div></blockquote>
<p>After training, the model weights will be saved and ready to use for predictions. We’ll evaluate performance on the test data in the next step.</p>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_name</span> <span class="o">=</span> <span class="s2">"new_model"</span>

<span class="c1"># Training params</span>
<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">weight_decay</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># (not passing test data into function to speed up training)</span>

<span class="n">new_model_path</span><span class="p">,</span> <span class="n">train_losses</span><span class="p">,</span> <span class="n">test_losses</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">train_seg</span><span class="p">(</span>
    <span class="n">model</span><span class="o">.</span><span class="n">net</span><span class="p">,</span>
    <span class="n">train_data</span><span class="o">=</span><span class="n">train_data</span><span class="p">,</span>
    <span class="n">train_labels</span><span class="o">=</span><span class="n">train_labels</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">n_epochs</span><span class="o">=</span><span class="n">n_epochs</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="n">weight_decay</span><span class="p">,</span>
    <span class="n">nimg_per_epoch</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)),</span>  <span class="c1"># can change this</span>
    <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-on-test-data">
<h2 style="color: black; background-color: rgb(127,196,125); padding: 3px; border-radius: 5px;">Evaluate on test data<a class="headerlink" href="#evaluate-on-test-data" title="Link to this heading">#</a></h2>
<div class="cell tag_skip-execution tag_teacher docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CellposeModel</span><span class="p">(</span><span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pretrained_model</span><span class="o">=</span><span class="n">new_model_path</span><span class="p">)</span>

<span class="c1"># run model on test images</span>
<span class="n">masks</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># check performance using ground truth labels</span>
<span class="n">ap</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">average_precision</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">masks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; average precision at iou threshold 0.5 = </span><span class="si">{</span><span class="n">ap</span><span class="p">[:,</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content/05_segmentation/deep_learning"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</article>
<footer class="prev-next-footer d-print-none">
<div class="prev-next-area">
<a class="left-prev" href="cellpose_notebook.html" title="previous page">
<i class="fa-solid fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">Cellpose in Python</p>
</div>
</a>
<a class="right-next" href="../../06_object_classification/object_classification.html" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">06 - <i class="fa-solid fa-shapes"></i> Object Classification</p>
</div>
<i class="fa-solid fa-angle-right"></i>
</a>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">
<div class="sidebar-secondary-item">
<div class="page-toc tocsection onthispage">
<i class="fa-solid fa-list"></i> Contents
  </div>
<nav class="bd-toc-nav page-toc">
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#make-sure-you-have-gpu-access">Make sure you have GPU access</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mount-your-google-drive">Mount your google drive</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-the-data">Download the Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#install-cellpose">Install Cellpose</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#import-libraries">Import Libraries</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-handling">Data Handling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#init-the-model">Init the Model</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#train-new-model">Train New Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-on-test-data">Evaluate on test data</a></li>
</ul>
</nav></div>
</div></div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By Federico Gasparoli - federico.gasparoli@gmail.com, Image Analysis Collaboratory @ Harvard Medical School
</p>
</div>
<div class="footer-item">
<p class="copyright">
    
      © Copyright 2025.
      <br>
</br></p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
<div class="extra_footer">
<p>
All content is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY 4.0</a>, except where noted otherwise.
</p>
</div>
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>
<footer class="bd-footer">
</footer>
</body>
</html>